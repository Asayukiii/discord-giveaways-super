"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Giveaway=void 0;const giveaway_interface_1=require("./giveaway.interface"),ms_1=require("./misc/ms"),MessageUtils_1=require("./util/classes/MessageUtils"),GiveawaysError_1=require("./util/classes/GiveawaysError"),giveawayTemplate_1=require("../structures/giveawayTemplate");class Giveaway{_giveaways;_messageUtils;_inputGiveaway;id;prize;time;state;winnersCount;startTimestamp;endTimestamp;endedTimestamp;messageID;messageURL;guild;host;channel;entriesCount;entries;isEnded;messageProps;constructor(e,s){this._giveaways=e,this._messageUtils=new MessageUtils_1.MessageUtils(e),this._inputGiveaway=s,this.id=s.id,this.prize=s.prize,this.time=s.time,this.state=s.state,this.winnersCount=s.winnersCount,this.startTimestamp=s.startTimestamp,this.endTimestamp=s.endTimestamp,this.endedTimestamp=s.endedTimestamp,this.messageID=s.messageID,this.guild=this._giveaways.client.guilds.cache.get(s.guildID),this.host=this._giveaways.client.users.cache.get(s.hostMemberID),this.channel=this._giveaways.client.channels.cache.get(s.channelID),this.messageURL=s.messageURL||"",this.isEnded=s.isEnded||!1,this.entries=new Set(s.entriesArray),this.entriesCount=s.entriesArray.length,this.messageProps=s.messageProps||{embeds:{start:{},joinGiveawayMessage:{},leaveGiveawayMessage:{},finish:{endMessage:{},newGiveawayMessage:{},noWinnersNewGiveawayMessage:{},noWinnersEndMessage:{}},reroll:{newGiveawayMessage:{},onlyHostCanReroll:{},rerollMessage:{},successMessage:{}}},buttons:{joinGiveawayButton:{},goToMessageButton:{},rerollButton:{}}}}get isFinished(){return this.state!==giveaway_interface_1.GiveawayState.STARTED||Date.now()>1e3*this.endTimestamp||this.isEnded}get raw(){const e=[...this.entries];return this._inputGiveaway.entriesArray=e,this._inputGiveaway}isRunning(){return!this.isFinished}async restart(){const{giveawayIndex:e}=this._getFromCache(this.guild.id);this.isEnded=!1,this.raw.isEnded=!1,this.endTimestamp=Math.floor((Date.now()+(0,ms_1.ms)(this.time))/1e3),this.raw.endTimestamp=Math.floor((Date.now()+(0,ms_1.ms)(this.time))/1e3);const s=this.messageProps,r=s?.embeds.start||{},a=this._messageUtils.buildGiveawayEmbed(this.raw,r),i=this._messageUtils.buildButtonsRow(s?.buttons.joinGiveawayButton||{}),t=await this.channel.messages.fetch(this.messageID);this._giveaways.database.pull(`${this.guild.id}.giveaways`,e,this.raw),t.edit({content:r?.messageContent,embeds:1==Object.keys(r).length&&r?.messageContent?[]:[a],components:[i]}),this._giveaways.emit("giveawayRestart",this)}async extend(e){const{giveaway:s,giveawayIndex:r}=this._getFromCache(this.guild.id);if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("extensionTime","Giveaways.extend"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("extensionTime","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if(this.isEnded)throw new GiveawaysError_1.GiveawaysError("Cannot extend the giveaway's length: "+GiveawaysError_1.errorMessages.GIVEAWAY_ALREADY_ENDED(s.prize,s.id),GiveawaysError_1.GiveawaysErrorCodes.GIVEAWAY_ALREADY_ENDED);this.endTimestamp=this.endTimestamp+this._timeToSeconds(e),this.raw.endTimestamp=this.endTimestamp+this._timeToSeconds(e);const a=this.messageProps,i=a?.embeds.start||{},t=this._messageUtils.buildGiveawayEmbed(this.raw,i),o=this._messageUtils.buildButtonsRow(a?.buttons.joinGiveawayButton||{}),n=await this.channel.messages.fetch(this.messageID);this._giveaways.database.pull(`${this.guild.id}.giveaways`,r,this.raw),n.edit({content:i?.messageContent,embeds:1==Object.keys(i).length&&i?.messageContent?[]:[t],components:[o]}),this._giveaways.emit("giveawayLengthExtend",{time:e,giveaway:this})}async reduce(e){const{giveaway:s,giveawayIndex:r}=this._getFromCache(this.guild.id);if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("reductionTime","Giveaways.extend"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("reductionTime","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if(this.isEnded)throw new GiveawaysError_1.GiveawaysError("Cannot reduce the giveaway's length: "+GiveawaysError_1.errorMessages.GIVEAWAY_ALREADY_ENDED(s.prize,s.id),GiveawaysError_1.GiveawaysErrorCodes.GIVEAWAY_ALREADY_ENDED);this.endTimestamp=this.endTimestamp-this._timeToSeconds(e),this.raw.endTimestamp=this.endTimestamp-this._timeToSeconds(e);const a=this.messageProps,i=a?.embeds.start||{},t=this._messageUtils.buildGiveawayEmbed(this.raw,i),o=this._messageUtils.buildButtonsRow(a?.buttons.joinGiveawayButton||{}),n=await this.channel.messages.fetch(this.messageID);this._giveaways.database.pull(`${this.guild.id}.giveaways`,r,this.raw),n.edit({content:i?.messageContent,embeds:1==Object.keys(i).length&&i?.messageContent?[]:[t],components:[o]}),this._giveaways.emit("giveawayLengthReduce",{time:e,giveaway:this})}async end(){const{giveaway:e,giveawayIndex:s}=this._getFromCache(this.guild.id),r=this._pickWinners(e);if(this.isEnded)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.GIVEAWAY_ALREADY_ENDED(e.prize,e.id),GiveawaysError_1.GiveawaysErrorCodes.GIVEAWAY_ALREADY_ENDED);const a=Date.now();this.isEnded=!0,this.raw.isEnded=!0,this.endedTimestamp=a,this.raw.endedTimestamp=a,this._giveaways.database.pull(`${this.guild.id}.giveaways`,s,this.raw),this._messageUtils.editFinishGiveawayMessage(this.raw,r,this.messageProps?.embeds.finish?.newGiveawayMessage),this._giveaways.emit("giveawayEnd",this)}async reroll(){const{giveaway:e}=this._getFromCache(this.guild.id),s=this._pickWinners(e),r=e.messageProps?.embeds?.reroll,a=r?.rerollMessage||{};for(const e in a)a[e]=(0,giveawayTemplate_1.replaceGiveawayKeys)(a[e],this,s);const i=this._messageUtils.buildGiveawayEmbed(this.raw,a,s),t=await this.channel.messages.fetch(this.messageID);return this._messageUtils.editFinishGiveawayMessage(this.raw,s,r?.newGiveawayMessage,!1,r?.successMessage),t.reply({content:a?.messageContent,embeds:Object.keys(a).length&&a?.messageContent?[]:[i]}),this._giveaways.emit("giveawayReroll",{newWinners:s,giveaway:this}),s}addEntry(e,s){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("guildID","Giveaway.addEntry"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if(!s)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("userID","Giveaway.addEntry"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("guildID","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if("string"!=typeof s)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("userID","string",s),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);const{giveaway:r,giveawayIndex:a}=this._getFromCache(e);return this.sync(r),this.entries.add(s),r.entriesCount=this.entries.size,this._giveaways.database.pull(`${e}.giveaways`,a,this.raw),r}removeEntry(e,s){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("guildID","Giveaway.removeEntry"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if(!s)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("userID","Giveaway.removeEntry"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("guildID","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if("string"!=typeof s)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("userID","string",s),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);const{giveaway:r,giveawayIndex:a}=this._getFromCache(e);return this.sync(r),this.entries.delete(s),r.entriesCount=this.entries.size,this.sync(r),this._giveaways.database.pull(`${e}.giveaways`,a,this.raw),r}async setPrize(e){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("prize","Giveaways.setPrize"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("prize","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);return this.edit("prize",e)}async setWinnersCount(e){if(null==e||null==e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("winnersCount","Giveaways.setWinnersCount"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if(isNaN(e))throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("winnersCount","number",e.toString()),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if(e<=0)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_INPUT("winnersCount","Giveaways.setWinnersCount","winners count cannot be less or equal 0"),GiveawaysError_1.GiveawaysErrorCodes.INVALID_INPUT);return this.edit("winnersCount",e)}async setHostMemberID(e){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("hostMemberID","Giveaways.setHostMemberID"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("hostMemberID","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);return this.edit("hostMemberID",e)}async setTime(e){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("time","Giveaways.setTime"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("time","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);return this.edit("time",e)}async edit(e,s){const{giveawayIndex:r}=this._getFromCache(this.guild.id);if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("key","Giveaways.edit"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if(!s)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("value","Giveaways.edit"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("key","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);if(this.isEnded)throw new GiveawaysError_1.GiveawaysError("Cannot edit the giveaway: "+GiveawaysError_1.errorMessages.GIVEAWAY_ALREADY_ENDED(this.prize,this.id),GiveawaysError_1.GiveawaysErrorCodes.GIVEAWAY_ALREADY_ENDED);const a=this.messageProps,i=a?.embeds.start||{},t={...this.raw}[e];if("hostMemberID"==e){const e=s,r=this._giveaways.client.users.cache.get(e);if(!r)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.USER_NOT_FOUND(e),GiveawaysError_1.GiveawaysErrorCodes.USER_NOT_FOUND);for(const e in i)"string"==typeof i[e]&&(i[e]=i[e].replaceAll(this.host.username,r.username).replaceAll(this.host.discriminator,r.discriminator).replaceAll(this.host.tag,r.tag).replaceAll(this.host.avatar,r.avatar).replaceAll(this.host.defaultAvatarURL,r.defaultAvatarURL).replaceAll(this.host.bot,r.bot).replaceAll(this.host.system,r.system).replaceAll(this.host.banner,r.banner).replaceAll(this.host.createdAt,r.createdAt).replaceAll(this.host.createdTimestamp,r.createdTimestamp).replaceAll(this.host.id,r.id));this.host=r,this.raw.hostMemberID=e}else if("time"==e){const e=s;this.time=e,this.raw.time=e,this.endTimestamp=Math.floor((Date.now()+(0,ms_1.ms)(e))/1e3),this.raw.endTimestamp=Math.floor((Date.now()+(0,ms_1.ms)(e))/1e3)}else{this[e]=s,this.raw[e]=s}const o=this._messageUtils.buildGiveawayEmbed(this.raw,i),n=this._messageUtils.buildButtonsRow(a?.buttons.joinGiveawayButton||{}),w=await this.channel.messages.fetch(this.messageID);return this._giveaways.database.pull(`${this.guild.id}.giveaways`,r,this.raw),w.edit({content:i?.messageContent,embeds:1==Object.keys(i).length&&i?.messageContent?[]:[o],components:[n]}),this._giveaways.emit("giveawayEdit",{key:e,oldValue:t,newValue:s,giveaway:this}),this}async delete(){const{giveawayIndex:e}=this._getFromCache(this.guild.id),s=await this.channel.messages.fetch(this.messageID);return s.deletable?s.delete():s.edit({content:"",embeds:[],components:[]}),this._giveaways.database.pop(`${this.guild.id}.giveaways`,e),this}sync(e){const s=this,r=e;if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("giveaway","Giveaway.sync"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("object"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("giveaway","object",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);for(const a in e)s[a]=r[a];for(const a in e)s.raw[a]=r[a]}_pickWinners(e){const s=[];if(e&&this.sync(e),!this.entries.size)return[];const r=this._shuffleArray([...this.entries]);for(let e=0;e<this.winnersCount;e++){const e=()=>{const a=Math.floor(Math.random()*r.length),i=r[a];s.includes(i)?s.length!==this.entries.size&&e():s.push(i)};e()}return s.map((e=>`<@${e}>`))}_shuffleArray(e){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("arrayToShuffle","Giveaway._shuffleArray"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if(!Array.isArray(e))throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("arrayToShuffle","array",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);const s=[...e];for(let e=s.length-1;e>0;e--){const r=Math.floor(Math.random()*(e+1));[s[e],s[r]]=[s[r],s[e]]}return s}_getFromCache(e){if(!e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.REQUIRED_ARGUMENT_MISSING("guildID","Giveaway._getFromCache"),GiveawaysError_1.GiveawaysErrorCodes.REQUIRED_ARGUMENT_MISSING);if("string"!=typeof e)throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.errorMessages.INVALID_TYPE("guildID","string",e),GiveawaysError_1.GiveawaysErrorCodes.INVALID_TYPE);const s=this._giveaways.database.get(`${e}.giveaways`)||[],r=s.findIndex((e=>e.id==this.id)),a=s[r];return this.sync(a),{giveaway:a,giveawayIndex:r}}_timeToSeconds(e){try{const s=(0,ms_1.ms)(e);return Math.floor(s/1e3/2)}catch{throw new GiveawaysError_1.GiveawaysError(GiveawaysError_1.GiveawaysErrorCodes.INVALID_TIME)}}toJSON(){return this.raw}}exports.Giveaway=Giveaway;
